<!DOCTYPE html>
<html>
  <head>
    <title>SportTracks Reader</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
      integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
      crossorigin=""></script>

    <script
			  src="https://code.jquery.com/jquery-3.5.1.min.js"
			  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
			  crossorigin="anonymous"></script>
    <script src='./src/SportTracks.js'></script>

    <style>
        form  { display: table;      }
        p     { display: table-row;  }
        label { display: table-cell; vertical-align: top}
        input { display: table-cell; }
  	</style>

</head>
<body>
<h2>SportTracks - Read workout data</h2>

<div id="invisibleMap"></div>

<form onsubmit="return getSTdata();">
  <label for="STindex">Index:&nbsp;</label>
  <input type="number" id="STindex" name="STindex" value="1" size="10" style="padding-right:5px; text-align:right;">&nbsp;
  <input type="submit" id="STget" value="Get from ST" disabled><br><br>
</form>

<form onsubmit="return setSTdata();" id="formSTdata">
	<p>
		<label id="labelSTtypedate">Type: </label>
		<input type="text" id="STtypedate" name="STtypedate" size="45" readonly>
	</p>
	<p>
		<label id="labelSTactivity">Activity: </label>
		<input type="url" id="STactivity" name="STactivity" size="45" readonly>
	</p>
  <p>
    <label for="STname" id="labelSTname">Name:      </label>
    <input type="text" id="STname" name="STname" size="45">
	</p>
	<p>
    <label for="STdistance">Distance:&nbsp;</label>
    <input type="text" id="STdistance" name="STname" size="7" style="padding-right:30px; text-align:right;"></input><span style="margin-left:-25px;">mi</span>&nbsp;&nbsp;
	  <input type="button" id="recalcButton" onclick="calcGPS(stActivityUpdate.location)" value="Recalc" disabled>
	</p>
  <label for="STnotes">Notes:</label>
  <textarea rows = "5" cols = "60" id="STnotes" name="STnotes">
  </textarea><br>
	<br>
  <input type="submit" id="STsend" value="Send to ST" disabled>&nbsp;&nbsp;
	<input type="button" id="STrevert" onclick="revertSTdata()" value="Revert" disabled>
	<br><br>
</form>
<br>
<br>

    <script>
      // setup SportTracksLink (if appropriate)
      //stTokens(); // setup tokens at startup - may need to refresh later
    	// where possible keep all references to HTML fields on this page
      var map = L.map('invisibleMap');
      sportTracksInfo(3);  // initialize

      function enableForm() { // ST connection made, enable form button(s)
          document.getElementById("STget").disabled = false;
      }

      function getSTdata() {
      	if ($("#formSTdata").serialize() != formSTdataOriginal) {
         	// warn it has changed
      		if (confirm("Data changed - override from SportTracks?") == false) {
      			return false;
      		}
      	}
        getFitnessActivityIndex( document.getElementById("STindex").value);
        return false;  // needed to avoid page refresh
      }

      function setSTdata() {
      	if (confirm("Send data to SportTracks?") == true) {
          stActivityUpdate.name = document.getElementById("STname").value;
          stActivityUpdate.total_distance = document.getElementById("STdistance").value * 1609.34;
          stActivityUpdate.notes = document.getElementById("STnotes").value;
          setFitnessActivity(stActivityUpdate);
          //make new text the baseline
          formSTdataOriginal = $("#formSTdata").serialize();
      	}
        return false;  // needed to avoid page refresh
      }

      function revertSTdata() {
        populateSTform (stActivityInit);
      }

      // populate form
      function populateSTform (stActivity) {
          var stDate = new Date (stActivity.start_time);
          if (stTest == true) {
            window.alert("SportTracks - index " + stIndex + ": \n  " + stActivity.name + " (" + stActivity.toLocaleString() + ")\n  " + stActivity.uri);
          }
          document.getElementById("STtypedate").value = stActivity.type + " (" + stDate.toLocaleString() + ")";
          document.getElementById("STactivity").value = stActivity.activity;
          document.getElementById("STname").value = stActivity.name;
          document.getElementById("STdistance").value = (stActivity.total_distance/1609.34).toFixed(2);  // convert to miles, show 2 dp
          document.getElementById("recalcButton").disabled = (typeof stActivity.location === 'undefined'); // button enabled if GPS data
          document.getElementById("STnotes").value = typeof stActivity.notes === 'undefined' ? "" : stActivity.notes;
          document.getElementById("STsend").disabled = false;
          document.getElementById("STrevert").disabled = false;
          // default data
          formSTdataOriginal = $("#formSTdata").serialize();
      }

      function calcGPS(gps) {
          var dist = 0;
          for (i = 3; i < gps.length; i=i+2) {
              dist += map.distance(gps[i-2], gps[i]);
          }
          var dist_mi = dist/1609.34;
          var orig_dist_mi = stActivityInit.total_distance/1609.34;
          document.getElementById("STdistance").value = (dist_mi).toFixed(2);
          document.getElementById("STnotes").value += "\nSTlink distance: " + dist_mi.toFixed(2) + " mi (original: " + orig_dist_mi.toFixed(2) +
            " mi)\n";
      }

    </script>
</body>
</html>
