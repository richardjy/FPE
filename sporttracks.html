<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SportTracks Editor</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
      integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
      crossorigin=""></script>

    <script
			  src="https://code.jquery.com/jquery-3.5.1.min.js"
			  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
			  crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
        integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
        crossorigin="anonymous"></script>

    <script src="./src/config.js"></script>
    <script src="./src/config_local.js"></script>
    <script src='./src/sporttracks.js'></script>

    <style>
        body  { font-size: 100%; font-family: Arial,Helvetica,sans-serif; background-color: #7A90AB;}
        input, button, select, option, textarea { font-size: 100%; background-color: #d1dae5; }

        form  { display: table;      }
        p     { display: table-row;  }
        label { display: table-cell; vertical-align: text-bottom; text-align: right; font-size: 90%; font-style: italic;}
        input { display: table-cell; }


        .ui-widget { font-size: 90%; }
        .ui-state-default, .ui-widget-content { background-color: #d1dae5; }
        .ui-tabs, .ui-tabs-nav { background-color: #7A90AB; }
        .ui-tooltip { white-space: pre-line; }
        #progressSTgear .ui-progressbar-value { background-color: #7A90AB; }

        fieldset { display:inline }
        pre { font-size: 100%; font-family: Arial,Helvetica,sans-serif; }
        textarea { font-family: inherit; font-size: inherit; }

  	</style>

</head>
<body>
<h2>SportTracks - Edit workout data</h2>

<div id="invisibleMap"></div>
<div style="display: inline-block">
    <span id="infoText">SportTrack authorization dialog should appear. If not check Browser Pop-up settings.</span>&nbsp;&nbsp;
    <span id="infoTextGear">&nbsp;</span>
</div>
<br><br>

<div>
  <fieldset  id="fieldSTindex">
    <legend>Activity Index</legend>
    <input id="STindex" name="STindex" value="1" size="10" style="padding-right:5px; text-align:right;"
    title="1 = latest activity, 2 = 2nd, etc&#013; or enter STmobi index number">&nbsp;
    <input type="submit" id="STgetButton" onclick="getSTdata()" value="Get from ST">
  </fieldset>
</div>
<br>

<div style="display: inline-block;">
  <fieldset id="fieldSTdata">
    <legend>Activity Overview</legend>
    <p>
  		<label id="labelSTtypedate">Type:&nbsp;</label>
  		<input type="text" id="STtypedate" name="STtypedate" size="45" readonly>
  	</p>
  	<p>
  		<label id="labelSTactivity">Activity:&nbsp;</label>
  		<input type="url" id="STactivity" name="STactivity" size="45" readonly>
  	</p>
    <p>
      <label for="STname" id="labelSTname">Name:&nbsp;</label>
      <input type="text" id="STname" name="STname" size="45">
  	</p>
    <p>
      <label for="STloc" id="labelSTloc">Location:&nbsp;</label>
      <input type="text" id="STloc" name="STloc" size="45">&nbsp;
      <input type="button" id="getLocButton" onclick="getLocation(stActivityUpdate.location)" value="Get Location"
          title="Location uses: [name,] city, state/country &#013; (Search by LocationIQ.com)">
    </p>
  	<p>
      <label for="STdistance">Distance:&nbsp;</label>
      <input type="text" id="STdistance" name="STname" size="7" style="padding-right:30px; text-align:right;"></input><span style="margin-left:-25px;">mi</span>&nbsp;&nbsp;&nbsp;
  	  <input type="button" id="recalcButton" onclick="calcGPS(stActivityUpdate.location)" value="Recalc"
          title="Recalculate distance based on simple addition of GPS points">
  	</p>
    <label for="STnotes">Notes:&nbsp;</label>
    <textarea rows = "5" cols = "60" id="STnotes" name="STnotes">
    </textarea><br>
  	<br>
    <input type="submit" id="STsendButton" onclick="setSTdata()" value="Send to ST">&nbsp;&nbsp;
  	<input type="button" id="STrevertButton" onclick="revertSTdata()" value="Revert">

  	<br><br>
  </fieldset>
</div>

<div id="tabs"  style="display: inline-block; vertical-align: top">
		<ul>
			<li><a href="#tab-gear">Gear</a></li>
			<li><a href="#tab-health">Health</a></li>
		</ul>
		<div id="tab-gear">
    	<div class="arrowButtons">
        <input type="button" id="STgetGearButton" onclick="getSTgearList()" value="Get Gear">&nbsp;&nbsp;
        <button id="gearLeft">Change Gear page</button>
        <button id="gearRight">Change Gear page</button>
        <br><br>
    	</div>
      <div id="progressSTgear"></div>
    	<div id="fieldSTgear">  </div>
		</div>
		<div id="tab-health">
			<div>
        <button id="STgetHealthButton" onclick="getSThealth()">Get Health</button>&nbsp;&nbsp;
        <input type="text" id="healthDate" size="10" style="text-align:center;">
        <br><br>
    	</div>
    	<div id="fieldSThealth">
        <p><label for="health1" id="lbl-health1" size="10"></label>&nbsp;<input type="text" id="health1" name="health1" size="8"></p>
        <p><label for="health2" id="lbl-health2" size="10"></label>&nbsp;<input type="text" id="health2" name="health2" size="8"></p>
        <p><label for="health3" id="lbl-health3" size="10"></label>&nbsp;<input type="text" id="health3" name="health3" size="8"></p>
        <p><label for="health4" id="lbl-health4" size="10"></label>&nbsp;<input type="text" id="health4" name="health4" size="8"></p>
        <p><label for="health5" id="lbl-health5" size="10"></label>&nbsp;<input type="text" id="health5" name="health5" size="8"></p>
        <p><label for="health6" id="lbl-health6" size="10"></label>&nbsp;<input type="text" id="health6" name="health6" size="8"></p>
        <p><label for="health7" id="lbl-health7" size="10"></label>&nbsp;<input type="text" id="health7" name="health7" size="8"></p>
      </div>
		</div>
</div>
<br>
<br>
    <script>
      // setup SportTracksLink (if appropriate)
      //stTokens(); // setup tokens at startup - may need to refresh later
    	// where possible keep all references to HTML fields on this page
      var map = L.map('invisibleMap');

      document.getElementById("fieldSTindex").disabled = true;
      document.getElementById("fieldSTdata").disabled = true;
      sportTracksInfo(3);  // initialize

      function enableForm() { // ST connection made, enable index area
          document.getElementById("fieldSTindex").disabled = false;
          document.getElementById("infoText").innerHTML = "&nbsp;";
          //$( "#STgetButton" ).button( "option", "disabled", false );
          //$( "#STindex" ).spinner( "option", "disabled", false );
          //$( "#STgetGearButton" ).button( "option", "disabled", false );
          //$( "#STgetHealthButton" ).button( "option", "disabled", false );  // may not need to diable (diable area instead)
          $( "#tabs" ).find("*").prop( "disabled", false );
      }

      $(function() {
        // disable controls to start with
        $( "#STgetButton, #getLocButton, #recalcButton, #STrevertButton, #STsendButton, #STgetGearButton, #STgetHealthButton" ).button(  );  // { disabled: true }
        $( document ).tooltip();
        $( "#fieldSTgear" ).controlgroup()  // click on control group
          .on('click', '[type="checkbox"]', function( event, ui ){
              if (stActivityID != 0) {
                // many variables are only used in console below for testing
                var gearID = parseInt(event.target.id.match(/[0-9]+/g));
                var dateOld = stGearUpdate[gearID].changed;
                var actNumOld = stGearUpdate[gearID].activities.length;
                if (event.target.checked == true) {
                    stGearUpdate[gearID].activities.push(parseInt(stActivityID));
                    // resort to get in order
                    stGearUpdate[gearID].activities.sort( function(a1,a2){ return a1 - a2 } );
                } else { // unched - must be in the list - double check
                    var i = stGearUpdate[gearID].activities.indexOf(parseInt(stActivityID));
                    if (i > -1) {
                      stGearUpdate[gearID].activities.splice(i, 1);
                    }
                }
                var actNumNew = stGearUpdate[gearID].activities.length;
                var dateNew = new Date();
                var dateISO = dateNew.toISOString().split('.')[0]+"Z";
                stGearUpdate[gearID].changed = dateISO;
                // change date - without ms
                //console.log('click ', gearID, 'act',stActivityID ,'old', actNumOld, dateOld, 'new', actNumNew , dateISO);
              }
          });
        $( "#STindex" ).spinner({
            disabled: true,
            min: 1,
            spin: function( event, ui ) {
                indexSpin = true;
            },
            stop: function( event, ui ) {
                // do check to ignore keypresses when typing the number
                //console.log('stop ', event);
                if (indexSpin == true) {
                    indexSpin = false;
                    getSTdata();
                }
            }
        });
        $( "#STindex" ).on( "keyup", function( event ) {
            //console.log('keyup ', event, event.keyCode);
            if ( event.keyCode == $.ui.keyCode.ENTER ) {
                getSTdata();  // allow enter key to also trigger the update
            }
        });
        $( "#gearLeft"  ).button( { icon: "ui-icon-circle-arrow-w", showLabel: false } )
            .on( "click", function( event ) {
                  gearIndexPage--;
                  showSTgear();
            });
        $( "#gearRight" ).button( { icon: "ui-icon-circle-arrow-e", showLabel: false } )
            .on( "click", function( event ) {
                  gearIndexPage++;
                  showSTgear();
            });
        $( "#progressSTgear" ).progressbar();
        $( "#progressSTgear" ).hide();
        $( "#tabs" ).tabs();
        $( "#tabs" ).find("*").prop( "disabled", true );
				$( "#healthDate" ).datepicker( { firstDay: 1 } );
        var options = { weekday: 'long'};
        $( "#healthDate" ).change( function() {
            document.getElementById("lbl-health1").innerHTML = $(this).datepicker('getDate').toLocaleDateString();
        })
        $( "#healthDate" ).datepicker( "setDate", "today" );
        document.getElementById("lbl-health1").innerHTML = $( "#healthDate" ).datepicker('getDate').toLocaleDateString() + ' ' + $( "#healthDate" ).datepicker('getDate').toString().split(' ')[0];
				$(document).ajaxStop(function () {  // come here at end of all GET POST etc
            if (getGear == true) {  // only react to one type of completion
              var filterGear = stGearInit.filter( function(g){ return g.status == "ACTIVE" } );
              stGearInit = filterGear; // not sure if can do in one step
              stGearInit.sort( function(g1,g2){ return g1.uri < g2.uri ? 1 : -1 } );  // sort based on uri for unique list
              stGearUpdate = JSON.parse(JSON.stringify(stGearInit));  // cloned copy
              getGear = false;
              $( "#progressSTgear" ).hide();
              prepGearList();
              document.getElementById("infoTextGear").innerHTML = "&nbsp;";
            }
            if (postActGear == true) {  // must be over
              postActGear = false;
              window.alert("Upload successful.");
            }
        });
      })


      function getSTdata() {
      	if ($("#fieldSTdata").serialize() != formSTdataOriginal) {
         	// warn it has changed
      		if (confirm("Data changed - override from SportTracks?") == false) {
      			return false;
      		}
      	}
        //document.getElementById("fieldSTdata").disabled = true;
        //document.getElementById("locText").innerHTML = "";
        document.getElementById("infoText").innerHTML = "Getting data...";
        getFitnessActivityIndex( document.getElementById("STindex").value);
      }

      function setSTdata() {
      	if (confirm("Send data to SportTracks?") == true) {
          stActivityUpdate.name = document.getElementById("STname").value;
          stActivityUpdate.location_name = document.getElementById("STloc").value;
          stActivityUpdate.total_distance = document.getElementById("STdistance").value * 1609.34;
          stActivityUpdate.notes = document.getElementById("STnotes").value;
          postActGear = true;   // set flag to show activity
          postFitnessActivity(stActivityUpdate);
          //make new text the baseline
          formSTdataOriginal = $("#fieldSTdata").serialize();
          // send changed gear
          // first sort array by activity to match init
          stGearUpdate.sort( function(g1,g2){ return g1.uri < g2.uri ? 1 : -1 } );  // sort based on uri for unique list
          for (i = 0; i < stGearUpdate.length; i++) {
            // check for change (based on number of activities)
            if (stGearUpdate[i].activities.length != stGearInit[i].activities.length) {
              //console.log('gear changed', i);
              postSTgearItem(stGearUpdate[i]);
            }
          }
          stGearInit = JSON.parse(JSON.stringify(stGearUpdate));  // use new list as init
          prepGearList();
      	}
      }

      function revertSTdata() {
        populateSTform (stActivityInit);
        // revert gear
        stGearUpdate = JSON.parse(JSON.stringify(stGearInit));  // revert to init version
        prepGearList();
      }

      function prepGearList() {
        if ( stGearUpdate.length > 0 && getGear == false && getActivity == false ) {
          stGearUpdate.sort( function(g1,g2){
            // sort gear with no activies to top of list
              var id1 = g1.activities.length > 0 ? g1.activities.slice(-1)[0] : 999999999999;
              var id2 = g2.activities.length > 0 ? g2.activities.slice(-1)[0] : 999999999999;
            return id2 -id1 } );  // sort based on last activityID
          if ( stActivityID != 0 ) {
            // not getting new activity data  AND activity ID exists -> bring used gear to front
            var usedGear = ([]);
            var i = 0; j = 0;
            //console.log('start', stGearUpdate);
            do {
              if (stGearUpdate[i].activities.indexOf(parseInt(stActivityID)) != -1) {
                //console.log('match  ', i);
                usedGear[j] = stGearUpdate.splice(i,1)[0];
                j++;
                // keep using same index as removed one
              } else {
                i++;
              }

            } while (i < stGearUpdate.length);

            //console.log('used', usedGear);
            //console.log('gear', stGearUpdate);
            for (i = usedGear.length - 1; i > -1 ; i--){
              stGearUpdate.unshift(usedGear[i]);
            }
          //  console.log('combo', stGearUpdate);
          }
          gearIndexPage = 0;
          showSTgear();
        }
      }

      function showSTgear() {
        // show gear list (global variable)
        // clear existing list
        $('#fieldSTgear').find('input').each(function () {
            $(this).remove();
            $('label[for=' + $(this).attr('id') + ']').remove();
        });
        var totalGear = stGearUpdate.length;
        if (totalGear != 0) {
          var maxPage = Math.ceil(totalGear / numGearPage) - 1;
          if (gearIndexPage > maxPage) gearIndexPage = 0;
          if (gearIndexPage < 0) gearIndexPage = maxPage;
          var maxOnPage = gearIndexPage < maxPage ? numGearPage : totalGear - maxPage*numGearPage
          var minI = numGearPage*gearIndexPage;
          var maxI = minI + maxOnPage;
          // test for max
          for (i = minI; i < maxI; i++) {
              var newCBox = '<input type="checkbox" name="checkbox-' + i + '" id="checkbox-' + i + '" /> <label for="checkbox-'+ i + '">test</label';
              $( "#fieldSTgear" ).append(newCBox);
              $( "#fieldSTgear" ).controlgroup( "option", "direction", "vertical" );
              var gearLbl = stGearUpdate[i].brand + ' - ' + stGearUpdate[i].model;
              $( "#checkbox-" + i ).checkboxradio( { label: gearLbl } ).checkboxradio( "refresh" );
              if (stActivityID != 0){
                // see if any checkbox ?
                if (stGearUpdate[i].activities.indexOf(parseInt(stActivityID)) != -1) {
                  //console.log('tick match', i);
                  $( "#checkbox-" + i ).prop('checked',true).checkboxradio('refresh')
                }

              }
          }
        }
      }

      // populate form
      function populateSTform (stActivity) {
          var stDate = new Date (stActivity.start_time);
          if (stTest == true) {
            window.alert("SportTracks - index " + stIndex + ": \n  " + stActivity.name + " (" + stActivity.toLocaleString() + ")\n  " + stActivity.uri);
          }
          document.getElementById("STtypedate").value = stActivity.type + " (" + stDate.toLocaleString() + ")";
          document.getElementById("STactivity").value = stActivity.activity;
          document.getElementById("STname").value = stActivity.name;
          document.getElementById("STloc").value = typeof stActivity.location_name === 'undefined' ? "" : stActivity.location_name;
          document.getElementById("STdistance").value = (stActivity.total_distance/1609.34).toFixed(2);  // convert to miles, show 2 dp
          document.getElementById("STnotes").value = typeof stActivity.notes === 'undefined' ? "" : stActivity.notes;
          $( "#getLocButton" ).button( "option", "disabled", typeof stActivity.location === 'undefined' ); // button enabled if GPS data
          $( "#recalcButton" ).button( "option", "disabled", typeof stActivity.location === 'undefined' ); // button enabled if GPS data
          $( "#STrevertButton" ).button( "option", "disabled", false ); // enable button (only needed once)
          $( "#STsendButton" ).button( "option", "disabled", false ); // enable button (only needed once)
          document.getElementById("STloc").title = ""; //remove tooltip
          //$( "#STgetGearButton" ).button( "option", "disabled", false ); // enable button (only needed once)
          document.getElementById("fieldSTdata").disabled = false;
          // default data
          formSTdataOriginal = $("#fieldSTdata").serialize();
          document.getElementById("infoText").innerHTML = "&nbsp;";
      }

      function calcGPS(gps) {
          var dist = 0;
          for (i = 3; i < gps.length; i=i+2) {
              dist += map.distance(gps[i-2], gps[i]);
          }
          var dist_mi = dist/1609.34;
          var orig_dist_mi = stActivityInit.total_distance/1609.34;
          document.getElementById("STdistance").value = (dist_mi).toFixed(2);
          document.getElementById("STnotes").value += "\nSTlink distance: " + dist_mi.toFixed(2) + " mi (original: " + orig_dist_mi.toFixed(2) +
            " mi)\n";
      }

      function getLocation(gps) {
          // add attribution to page
          //console.log(gps, typeof gps);
          if (typeof gps !== 'undefined') {
            var latCoord = gps[1][0];
            var lonCoord = gps[1][1];
            // max rate 2 per second (see if get any errors)
            var urlLiq = 'https://us1.locationiq.com/v1/reverse.php?key=' + config.locIQkey + '&format=json&' +
                'normalizeaddress=1&normalizecity=1&statecode=1&' +
                'lat=' + latCoord + '&lon=' + lonCoord;
            // max rate is 1 per second (need to add protection)
            // var urlOSM ='https://nominatim.openstreetmap.org/reverse?format=jsonv2&' +
            //     'lat=' + latCoord + '&lon=' + lonCoord;
            //var policy = {'User-Agent': 'FPE SportTracks Editor'};  // per policy
            //console.log(urlOSM);
            //console.log(urlLiq);
            $.ajax({
                type: 'GET',
                url: urlLiq
                // url: urlOSM,
                // headers: {
                //   'User-Agent': 'FPE SportTracks Editor'
                // }
            })
            .done(function(data, status){
                //console.log('data = ', data);
                // US: [name,] city, state_code     (if country_code == 'us')
                // non-US: [name,] city, country_code
                var locData = JSON.stringify(data.address, null, 5);
                var locAddress = typeof data.address.name === 'undefined' ? "" : data.address.name + ', ';
                if (data.address.country_code == 'us') {
                  locAddress += data.address.city + ", " + data.address.state_code.toUpperCase();
                } else {   // non-US
                  locAddress += data.address.city + ", " + data.address.country_code.toUpperCase();
                }
                document.getElementById("STloc").value = locAddress;
                document.getElementById("STloc").title = locData;
            })
            .fail(function(response) {
              window.alert("Geocode request failed.");
            });
          }
      }

    </script>
</body>
</html>
