<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SportTracks Link</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin=""></script>

    <script
			  src="https://code.jquery.com/jquery-3.5.1.min.js"
			  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
			  crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
        integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
        crossorigin="anonymous"></script>

    <script src="./src/config.js"></script>
    <script src="./src/config_local.js"></script>
    <script src="./src/stravalink.js"></script>
    <script src='./src/sporttracks.js'></script>
    <script src='./src/stanalysis.js'></script>
    <script src='./src/jquery.sparkline.min.js'></script>

    <style>
        body  { font-size: 100%; font-family: Arial,Helvetica,sans-serif; background-color: #7A90AB;}
        input, button, select, option, textarea { font-size: 100%; background-color: #d1dae5; }

        form  { display: table;      }
        p     { display: table-row;  }
        label { display: table-cell; vertical-align: text-bottom; text-align: right; font-size: 90%; font-style: italic;}
        input { display: table-cell; }


        .ui-widget { font-size: 90%; }
        .ui-state-default, .ui-widget-content { background-color: #d1dae5; }
        .ui-tabs, .ui-tabs-nav { background-color: #7A90AB; }
        .ui-tooltip { white-space: pre-line; }
        .ui-progressbar-value { background-color: #7A90AB; }
        .ui-progressbar { position: relative;  }
        .progress-label {
            position: absolute;
            left: 20%;
            top: 4px;
            font-weight: bold;
            text-shadow: 1px 1px 0 #fff;
          }

        fieldset { display:inline }
        pre { font-size: 100%; font-family: Arial,Helvetica,sans-serif; }
        textarea {
          font-family: inherit; font-size: inherit;
          -moz-tab-size : 18;
          -o-tab-size : 18;
          tab-size : 18;
          white-space: pre;
          overflow-x: auto;
        }
        td.healthdataexists a { background-color: #90EE90 !important; font-weight:bold !important; }

  	</style>

</head>
<body>
<h2>SportTracks - Edit workout data</h2>
<div style="display: inline-block"><span id="infoText"> </span></div>
<br><br>
<div>
  <fieldset  id="fieldSTindex">
    <legend>Activity Index</legend>
    <input id="STindex" name="STindex" value="1" size="10" style="padding-right:5px; text-align:right;"
    title="1 = latest activity, 2 = 2nd, etc&#013; (relative to date and earlier)&#013; or enter STmobi index number">&nbsp;
    <input type="submit" id="STgetButton" onclick="getSTdata()" value="Get from ST">&nbsp;
    <input type="text" id="idDate" size="10" style="text-align:center;">
  </fieldset>
</div>
<br>
<div style="display: inline-block;">
  <fieldset id="fieldSTdata">
    <legend>Activity Overview</legend>
    <div style="display: table;">
      <p>
    		<label id="labelSTtypedate" style="line-height:1.7;">Type:&nbsp;</label>
    		 &nbsp;<span id="STtypedate" name="STtypedate"></span>
    	</p>
      <p>
        <label id="labelSTactivity" style="line-height:1.7;">Link:&nbsp;</label>
        &nbsp;<a href="#" target="_blank" rel="noopener noreferrer" id="STactivity"></a>
      </p>
      <p>
        <label for="STname" id="labelSTname">Name:&nbsp;</label>
        <input type="text" id="STname" name="STname" size="45">
    	</p>
      <p>
        <label for="STloc" id="labelSTloc">Location:&nbsp;</label>
        <input type="text" id="STloc" name="STloc" size="45">&nbsp;
        <input type="button" id="getLocButton" onclick="getLocation(stActivityUpdate.location)" value="Get Location"
            title="Location uses: [name,] city, state/country &#013; (Search by LocationIQ.com)">
      </p>
    	<p>
        <label for="STdistance">Distance:&nbsp;</label>
        <input type="text" id="STdistance" name="STdistance" size="4" style="padding-right:30px; text-align:right;"></input><span style="margin-left:-25px;">mi</span>&nbsp;&nbsp;
        <input type="text" id="STactiveT" name="STactiveT" size="6" style="text-align:center;">&nbsp;&nbsp;
        <input type="button" id="recalcButton" onclick="calcGPS(stActivityUpdate.location)" value="Recalc"
            title="Recalculate distance based on simple addition of GPS points">&nbsp;
        <input type="text" id="STactiveP" name="STactiveP" size="3" readonly style="padding-right:33px; text-align:right;"></input><span style="margin-left:-28px;">/mi</span>
    	</p>
      <p>
        <label for="STelev">Elevation:&nbsp;</label>
        <input type="text" id="STelev" name="STelev" size="18" readonly style="text-align:center;">
      </p>
      <br>
      <p>
        <label for="STnotes">Notes:&nbsp;&nbsp;&nbsp;</label>
        <label for="cbWrap">Wrap text
          <input type="checkbox" name="cbWrap" id="cbWrap">
        </label>&nbsp;&nbsp;&nbsp;
        <input type="button" id="getStrava" onclick="getStrava()" value="Get Strava"
            title="Get 'Title' and 'Description' from Strava">
      </p>
    </div>
    <textarea rows = "10" cols = "70" id="STnotes" name="STnotes" ></textarea>
    <br><br>
    <div>
      <input type="submit" id="STsendButton" onclick="setSTdata()" value="Send to ST">&nbsp;&nbsp;
  	   <input type="button" id="STrevertButton" onclick="revertSTdata()" value="Revert All">&nbsp;&nbsp;
       <div id="progressSTact" style="float: right; width: 40%; right: 15%;"><div class="progress-label">Activity data...</div></div>
    </div>
    <br>
    <div id="invisibleMap" style="display: inline-block; width: 300px; height: 200px;"></div>
  </fieldset>
</div>

<div id="tabs"  style="display: inline-block; vertical-align: top">
		<ul>
			<li><a href="#tab-gear">Gear</a></li>
      <li><a href="#tab-data">Data</a></li>
			<li><a href="#tab-health">Health</a></li>
		</ul>
		<div id="tab-gear">
    	<div class="arrowButtons">
        <input type="button" id="STgetGearButton" onclick="getSTgearList()" value="Get Gear">&nbsp;&nbsp;
        <button id="gearLeft">Change Gear page</button>
        <button id="gearRight">Change Gear page</button>
        <br><br>
    	</div>
      <div id="progressSTgear"><div class="progress-label">Getting gear...</div></div>
    	<div id="fieldSTgear">  </div>
		</div>
    <div id="tab-data">
      <div style="display: inline-block; margin-right:20px;">
        <p>
          <label id="labelElevFilter">Elevation filter:&nbsp;</label>
          <input type="text" id="elevFilter" name="textDataInput" size="3" style="padding-right:30px; text-align:right;"></input><span style="margin-left:-25px;">m</span>
        </p>
        <p>
          <label id="labelLevel">Level threshold:&nbsp;</label>
          <input type="text" id="levelGrade" name="textDataInput" size="3" style="padding-right:30px; text-align:right;"></input><span style="margin-left:-25px;">%</span>
        </p>
        <p>
          <label id="labelWalkGCT">GCT walk threshold:&nbsp;</label>
          <input type="text" id="walkGCT" name="textDataInput" size="3" style="padding-right:30px; text-align:right;"></input><span style="margin-left:-25px;">ms</span>
        </p>
        <p>
          <label id="labelWalkCad">Cadence walk threshold:&nbsp;</label>
          <input type="text" id="walkCad" name="textDataInput" size="2.7" style="padding-right:36px; text-align:right;"></input><span style="margin-left:-31px;">spm</span>
        </p>
      </div>
      <div style="display: inline-block; vertical-align: top">
        <span class="elevSparkline"></span>
        <div id="timeRange" style="width:600px;"></div>
        <div style = "text-align: center; width:600px; padding-top:4px;">
          <input type="text" id="minTime" name="minTime" size="6" readonly style="text-align:center;">&nbsp;&nbsp;&nbsp;to&nbsp;
          <input type="text" id="maxTime" name="maxTime" size="6" readonly style="text-align:center;">
        </div>
      </div>

      <br><br>
      <label for="cbMetrics">Show metrics
        <input type="checkbox" name="cbMetrics" id="cbMetrics">
      </label>
      <label for="cbData">Show raw data
        <input type="checkbox" name="cbMetrics" id="cbData">
      </label>
      <label for="cbSIunits">Use meters
        <input type="checkbox" name="cbMetrics" id="cbSIunits">
      </label>&nbsp;&nbsp;&nbsp;&nbsp;
      <input type="button" id="STmaxData" onclick="maxData()" value="Max">
      <label for="cbGraphHR">HR
        <input type="checkbox" name="cbGraph" id="cbGraphHR">
      </label>
      <label for="cbGraphP">Power
        <input type="checkbox" name="cbGraph" id="cbGraphP">
      </label>
      <label for="cbGraphBig">Enlarge
        <input type="checkbox" name="cbGraph" id="cbGraphBig">
      </label>
      <br>
      <textarea rows = "26" cols = "140" id="showData" name="showData"></textarea><br>
      <div id="dataDisplay">  </div>
    </div>
		<div id="tab-health">
			<div>
        <button id="STgetHealthButton" onclick="getSThealth()">Get Health</button>&nbsp;&nbsp;
        <input type="text" id="healthDate" size="10" style="text-align:center;">
        <br><br>
    	</div>
    	<div id="fieldSThealth" >
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<select id="healthSel" name="healthSel" style="text-align:center;"></select>
        <p><label for="health1" id="lbl-health1" size="10"></label>&nbsp;<input type="text" id="health1" name="health1" size="8" style="text-align:center;"></p>
        <p><label for="health2" id="lbl-health2" size="10"></label>&nbsp;<input type="text" id="health2" name="health2" size="8" style="text-align:center;"></p>
        <p><label for="health3" id="lbl-health3" size="10"></label>&nbsp;<input type="text" id="health3" name="health3" size="8" style="text-align:center;"></p>
        <p><label for="health4" id="lbl-health4" size="10"></label>&nbsp;<input type="text" id="health4" name="health4" size="8" style="text-align:center;"></p>
        <p><label for="health5" id="lbl-health5" size="10"></label>&nbsp;<input type="text" id="health5" name="health5" size="8" style="text-align:center;"></p>
        <p><label for="health6" id="lbl-health6" size="10"></label>&nbsp;<input type="text" id="health6" name="health6" size="8" style="text-align:center;"></p>
        <p><label for="health7" id="lbl-health7" size="10"></label>&nbsp;<input type="text" id="health7" name="health7" size="8" style="text-align:center;"></p>
        <br>
        <button id="STsendHealthButton" onclick="sendSThealth()">Upload Health</button>
      </div>
      <br>
      <div id="progressHealth"><div class="progress-label">Health data...</div></div>
		</div>
</div>
<br>
<br>
    <script>
      // setup SportTracksLink (if appropriate)
      //stTokens(); // setup tokens at startup - may need to refresh later
    	// where possible keep all references to HTML fields on this page
      var mapST = L.map('invisibleMap', {zoomControl: false}).setView([51.505, -0.09], 13);
      var CartoDB_DarkMatterNoLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
      }).addTo(mapST);
      L.control.zoom({
        position: 'topright'
      }).addTo(mapST);

      document.getElementById("fieldSTindex").disabled = true;
      document.getElementById("fieldSTdata").disabled = true; // tabs disabled below
      sportTracksInfo();  // initialize - move to $(function() {   ??

      function enableForm() { // ST connection made, enable index area
          document.getElementById("fieldSTindex").disabled = false;
          document.getElementById("infoText").innerHTML = "&nbsp;";
          $( "#STindex" ).spinner( "option", "disabled", false );
          $( "#tabs" ).find("*").prop( "disabled", false );
          formSTdataOriginal = $("#formSTdata").serialize();  // to check if data has changed - where is best place?
          healthOriginal = $("#fieldSThealth input").serialize();
      }

      $(function() {
        $( "#STgetButton, #getLocButton, #recalcButton, #STrevertButton, #STsendButton, #STgetGearButton," +
            " #STgetHealthButton, #STsendHealthButton, #STmaxData, #getStrava" ).button(  );  // { disabled: true }
        $( document ).tooltip();
        $( "#fieldSTgear" ).controlgroup()  // click on control group
          .on('click', '[type="checkbox"]', function( event, ui ){
              if (stActivityID != 0) {
                // many variables are only used in console below for testing
                var gearID = parseInt(event.target.id.match(/[0-9]+/g));
                var dateOld = stGearUpdate[gearID].changed;
                var actNumOld = stGearUpdate[gearID].activities.length;
                if (event.target.checked == true) {
                    stGearUpdate[gearID].activities.push(parseInt(stActivityID));
                    // resort to get in order
                    stGearUpdate[gearID].activities.sort( function(a1,a2){ return a1 - a2 } );
                } else { // unched - must be in the list - double check
                    var i = stGearUpdate[gearID].activities.indexOf(parseInt(stActivityID));
                    if (i > -1) {
                      stGearUpdate[gearID].activities.splice(i, 1);
                    }
                }
                var actNumNew = stGearUpdate[gearID].activities.length;
                var dateNew = new Date();
                var dateISO = dateNew.toISOString().split('.')[0]+"Z";
                stGearUpdate[gearID].changed = dateISO;
                // change date - without ms
                //console.log('click ', gearID, 'act',stActivityID ,'old', actNumOld, dateOld, 'new', actNumNew , dateISO);
              }
          });
        $( "#STindex" ).spinner({
            disabled: true,
            min: 1,
            spin: function( event, ui ) {
                indexSpin = true;
            },
            stop: function( event, ui ) {
                // do check to ignore keypresses when typing the number
                //console.log('stop ', event);
                if (indexSpin == true) {
                    indexSpin = false;
                    getSTdata();
                }
            }
        });
        $( "#STindex" ).on( "keyup", function( event ) {
            //console.log('keyup ', event, event.keyCode);
            if ( event.keyCode == $.ui.keyCode.ENTER ) {
                getSTdata();  // allow enter key to also trigger the update
            }
        });
        $( "#gearLeft"  ).button( { icon: "ui-icon-circle-arrow-w", showLabel: false } )
            .on( "click", function( event ) {
                  gearIndexPage--;
                  showSTgear();
            });
        $( "#gearRight" ).button( { icon: "ui-icon-circle-arrow-e", showLabel: false } )
            .on( "click", function( event ) {
                  gearIndexPage++;
                  showSTgear();
            });
        $( "#progressSTgear, #progressHealth, #progressSTact" ).progressbar();
        $( "#progressHealth, #progressSTact" ).progressbar("value", false);
        $( "#progressSTgear, #progressHealth, #progressSTact" ).hide();
        $( "#tabs" ).tabs({
            activate: function( event, ui ) {
              //console.log(ui.newTab[0].textContent);
              // only needed when switching to datatab, but include in case add any more sparklines
              $.sparkline_display_visible();
            }
        });

        $( "#cbWrap, #cbMetrics, #cbData, #cbSIunits, #cbGraphHR, #cbGraphP, #cbGraphBig" ).checkboxradio();
        // default is metrics checked - using HTML gives caret rather than checkmark
        $( "#cbMetrics" ).prop('checked',true).checkboxradio('refresh');
        $( "[name='textDataInput']").on( "change", refreshData );
        $( "#STdistance").on( "change", function () {
            var checkDist = $( "#STdistance").val();
            if(isNaN(checkDist) || checkDist<0 || checkDist.trim().length == 0) {
              alert('Distance is not valid - revert to saved.');
              $( "#STdistance").val((stActivityUpdate.total_distance/MI2M).toFixed(2));  // convert to miles, show 2 dp
            }
            $( "#STactiveP").val(calcUIPace());
            // force calc of summary
            displaySummary();

        });
        $( "#STactiveT").on( "change", function () {
            var uiTimeS = timeS($( "#STactiveT" ).val());
            if(uiTimeS == -1) {
              alert('Time is not valid - revert to saved.');
              $( "#STactiveT").val(timeHMS(stActivityUpdate.duration));  //
            }
            $( "#STactiveP").val(calcUIPace());
        });
        $( "#cbWrap").on( "change",  function () {
            $( "#STnotes" ).css("white-space", $( "#cbWrap" )[0].checked ? "pre-wrap" : "pre" );
          });
        $( "#timeRange" ).slider({
            range: true,
            min: 0,
            max: 600,
            values: [ 0, 600 ],
            slide: function( event, ui ) {
              $( "#minTime" ).val( timeHMS(ui.values[0]) );
              $( "#maxTime" ).val( timeHMS(ui.values[1]) );
              calcMetrics();  // need to key these off slider values
              displayMetrics();
            },
            stop: function( event, ui ) {
              $( "#minTime" ).val( timeHMS(ui.values[0]) );
              $( "#maxTime" ).val( timeHMS(ui.values[1]) );
              calcMetrics();  // need to key these off slider values
              displayMetrics();
            }
        });
        showSparkLine();
        $( "[name='cbMetrics']").on( "change", displayMetrics );
        $( "[name='cbGraph']").on( "change", showSparkLine );
        // put this after all visible controls
        $( "#tabs" ).find("*").prop( "disabled", true );
        $( "#healthSel" ).selectmenu( {
              width: 150,
              change: function() {  // don't warn about changes - would need way to revert to previous selection
                displayHealth();
              }
        });
        $( "#healthDate" ).datepicker( {
              firstDay: 1,
              beforeShowDay: checkValueDate,
              showOtherMonths: true,
              selectOtherMonths: true,
              showWeek: true,
              showButtonPanel: true
        } );
        $( "#healthDate" ).change( function() {
          if (typeof stHealthInit !== 'undefined') displayHealth();
        })
        $( "#healthDate" ).datepicker( "setDate", "today" );
        $( "#fieldSThealth" ).hide();
        $( "#idDate" ).datepicker( {
              firstDay: 1,
              showOtherMonths: true,
              selectOtherMonths: true,
              showWeek: true,
              showButtonPanel: true,
              changeMonth: true,
              changeYear: true
        } );
        $( "#idDate" ).datepicker( "setDate", "today" );

				$(document).ajaxStop(function () {  // come here at end of all GET POST etc
            if (getGear == true) {  // only react to one type of completion
              var filterGear = stGearInit.filter( function(g){ return g.status == "ACTIVE" } );
              stGearInit = filterGear; // not sure if can do in one step
              stGearInit.sort( function(g1,g2){ return g1.uri < g2.uri ? 1 : -1 } );  // sort based on uri for unique list
              stGearUpdate = JSON.parse(JSON.stringify(stGearInit));  // cloned copy
              getGear = false;
              prepGearList();
              $( "#progressSTgear" ).hide();
            }
            if (postActGear == true) {  // must be over
              postActGear = false;
              $( "#progressSTact" ).hide();
              //window.alert("Upload successful.");
            }
        });
      })

      function displayHealth() {
        var selDate =  new Date($( "#healthDate" ).datepicker('getDate'));
        var day = selDate.getDay() || 7;
        selDate.setHours(-24*( day - 1));
        for (i = 0; i < 7 ; i++ ) {
          var lblDate =  selDate.toLocaleDateString() + ' ' + selDate.toString().split(' ')[0][0];  // should be Monday, but allow for changes later
          document.getElementById( "lbl-health" + (i+1) ).innerHTML = lblDate
          //if (typeof stHealthInit !== 'undefined' && typeof stHealthInit.weight !== 'undefined') {  // should not be needed
              document.getElementById( "health" + (i+1) ).value = getValueDate(stHealthInit, selDate);
          //}
          selDate.setHours(24); // add a day - strange behavior around DST
        }
        healthOriginal = $("#fieldSThealth input").serialize();
      }

      function sendSThealth(){
        // chack what has changed - set to midnight local time
        var healthdata = {};
        var metric = $("#healthSel").val();
        healthdata[metric] = ([]);
        var index = 0;
        var selDate = new Date((document.getElementById( "lbl-health1" ).innerHTML).slice(0,-2));
        for (i = 0; i < 7 ; i++ ) {
          var boxVal = $.trim(document.getElementById( "health" + (i+1) ).value);  // remove white space from front and back
          // check for positive values only?
          if ($.isNumeric(boxVal) || boxVal == '') {
              if (document.getElementById( "health" + (i+1) ).value != getValueDate(stHealthInit, selDate)) {
                // different value so add to array
                if ($.isNumeric(boxVal)) {
                    healthdata[metric][index] = [ selDate.toISOString().split('.')[0]+"Z",  metric == 'weight' ? (boxVal/KG2LB).toFixed(3) : metric == 'bodyFat' ? (boxVal/100).toFixed(3) : (boxVal*1.0).toFixed(0) ];
                } else {
                    healthdata[metric][index] = [ selDate.toISOString().split('.')[0]+"Z", null ];
                }
                index++
              }
          } else {
            // bad data - exit or ignore?
          }
          selDate.setHours(24); // add a day - strange behavior around DST
        }
        console.log(index, healthdata);
        if (index > 0) {
          postSThealth(healthdata);  // if it succeeds then array is updated
        }
      }

      function getValueDate(valType, valDate) {
        var metric = $("#healthSel").val();
        var valData = '';
        if (typeof valType[metric] !== 'undefined') {
          var result = valType[metric].find( function(val) {
            var isoSel = valDate.toISOString().substring(0,10);
            return val[0].includes(isoSel);
          });
          if (typeof result !== 'undefined') {
            valData = metric == 'weight' ? (result[1]*KG2LB).toFixed(2) : metric == 'bodyFat' ? (result[1]*100).toFixed(1) : result[1].toFixed(0);
          }
        }
        return valData;
      }

      function checkValueDate( valDate ) {
        var result = '';
        if (typeof stHealthInit !== 'undefined') {
            result = getValueDate(stHealthInit, valDate);
        }
        return [true, result == '' ? '' : 'healthdataexists', result]
      }

      function getSTdata() {
      	if ($("#fieldSTdata").serialize() != formSTdataOriginal) {
         	// warn it has changed
      		if (confirm("Data changed - override from SportTracks?") == false) {
      			return false;
      		}
      	}
        $( "#progressSTact" ).show();
        getFitnessActivityIndex( document.getElementById("STindex").value);
      }

      function setSTdata() {
      	if (confirmUpload == false || confirm("Send data to SportTracks?") == true) {
          $( "#progressSTact" ).show();
          stActivityUpdate.name = document.getElementById("STname").value;
          stActivityUpdate.location_name = document.getElementById("STloc").value;
          stActivityUpdate.total_distance = document.getElementById("STdistance").value * MI2M;
          var durS = timeS($( "#STactiveT" ).val());
          stActivityUpdate.duration = durS != -1 ? durS : stActivityInit.duration ;
          stActivityUpdate.notes = document.getElementById("STnotes").value;
          postActGear = true;   // set flag to show activity
          postFitnessActivity(stActivityUpdate);
          //make new text the baseline
          formSTdataOriginal = $("#fieldSTdata").serialize();
          // send changed gear
          // first sort array by activity to match init
          stGearUpdate.sort( function(g1,g2){ return g1.uri < g2.uri ? 1 : -1 } );  // sort based on uri for unique list
          for (i = 0; i < stGearUpdate.length; i++) {
            // check for change (based on number of activities)
            if (stGearUpdate[i].activities.length != stGearInit[i].activities.length) {
              //console.log('gear changed', i);
              postSTgearItem(stGearUpdate[i]);
            }
          }
          stGearInit = JSON.parse(JSON.stringify(stGearUpdate));  // use new list as init
          prepGearList();
      	}
      }

      function revertSTdata() {
        populateSTform (stActivityInit);
        // revert gear
        stGearUpdate = JSON.parse(JSON.stringify(stGearInit));  // revert to init version
        prepGearList();
      }

      function prepGearList() {
        if ( stGearUpdate.length > 0 && getGear == false && getActivity == false ) {
          stGearUpdate.sort( function(g1,g2){
            // sort gear with no activies to top of list
              var id1 = g1.activities.length > 0 ? g1.activities.slice(-1)[0] : 999999999999;
              var id2 = g2.activities.length > 0 ? g2.activities.slice(-1)[0] : 999999999999;
            return id2 -id1 } );  // sort based on last activityID
          if ( stActivityID != 0 ) {
            // not getting new activity data  AND activity ID exists -> bring used gear to front
            var usedGear = ([]);
            var i = 0; j = 0;
            //console.log('start', stGearUpdate);
            do {
              if (stGearUpdate[i].activities.indexOf(parseInt(stActivityID)) != -1) {
                //console.log('match  ', i);
                usedGear[j] = stGearUpdate.splice(i,1)[0];
                j++;
                // keep using same index as removed one
              } else {
                i++;
              }

            } while (i < stGearUpdate.length);

            //console.log('used', usedGear);
            //console.log('gear', stGearUpdate);
            for (i = usedGear.length - 1; i > -1 ; i--){
              stGearUpdate.unshift(usedGear[i]);
            }
          //  console.log('combo', stGearUpdate);
          }
          gearIndexPage = 0;
          showSTgear();
        }
      }

      function showSTgear() {
        // show gear list (global variable)
        // clear existing list
        $('#fieldSTgear').find('input').each(function () {
            $(this).remove();
            $('label[for=' + $(this).attr('id') + ']').remove();
        });
        var totalGear = stGearUpdate.length;
        if (totalGear != 0) {
          var maxPage = Math.ceil(totalGear / numGearPage) - 1;
          if (gearIndexPage > maxPage) gearIndexPage = 0;
          if (gearIndexPage < 0) gearIndexPage = maxPage;
          var maxOnPage = gearIndexPage < maxPage ? numGearPage : totalGear - maxPage*numGearPage
          var minI = numGearPage*gearIndexPage;
          var maxI = minI + maxOnPage;
          // test for max
          for (i = minI; i < maxI; i++) {
              var newCBox = '<input type="checkbox" name="checkbox-' + i + '" id="checkbox-' + i + '" /> <label for="checkbox-'+ i + '">test</label';
              $( "#fieldSTgear" ).append(newCBox);
              $( "#fieldSTgear" ).controlgroup( "option", "direction", "vertical" );
              var gearLbl = stGearUpdate[i].brand + ' - ' + stGearUpdate[i].model;
              $( "#checkbox-" + i ).checkboxradio( { label: gearLbl } ).checkboxradio( "refresh" );
              if (stActivityID != 0){
                // see if any checkbox ?
                if (stGearUpdate[i].activities.indexOf(parseInt(stActivityID)) != -1) {
                  //console.log('tick match', i);
                  $( "#checkbox-" + i ).prop('checked',true).checkboxradio('refresh')
                }
              }
          }
        }
      }

      // populate form
      function populateSTform (stActivity) {
          var stDate = new Date (stActivity.start_time);
          document.getElementById("STtypedate").innerHTML = stActivity.type + " (" + stDate.toDateString().substr(0,4) + stDate.toLocaleString() + ")";
          // link to 'sorttracks.mobi' rather than 'api.sorttracks.mobi'
          var actURL = LINKURL + stActivity.activity.split("/").pop();
          document.getElementById("STactivity").innerHTML = actURL;
          document.getElementById("STactivity").href = actURL;
          document.getElementById("STname").value = stActivity.name;
          document.getElementById("STloc").value = typeof stActivity.location_name === 'undefined' ? "" : stActivity.location_name;
          document.getElementById("STdistance").value = (stActivity.total_distance/MI2M).toFixed(2);  // convert to miles, show 2 dp
          document.getElementById("STactiveT").value = timeHMS(stActivity.duration);
          document.getElementById("STactiveP").value = calcUIPace();

          $( "#STelev" ).val((typeof stActivity.elevation_gain === 'undefined' ? '' : '+' + elevFeet(stActivity.elevation_gain)) + (typeof stActivity.elevation_loss === 'undefined' ? '' : ' / -' + elevFeet(stActivity.elevation_loss) + ' ft') );

          document.getElementById("STnotes").value = typeof stActivity.notes === 'undefined' ? "" : stActivity.notes;

          $( "#getLocButton" ).button( "option", "disabled", typeof stActivity.location === 'undefined' ); // button enabled if GPS data
          $( "#recalcButton" ).button( "option", "disabled", typeof stActivity.location === 'undefined' ); // button enabled if GPS data
          mapST.eachLayer(function (layer) {
            if (layer instanceof L.Polyline) mapST.removeLayer(layer);
          });
          if (typeof stActivity.location !== 'undefined') {
            var stLatLngs = [];
            var j =0;
            for (i = 1; i < stActivity.location.length; i=i+2) {
                stLatLngs[j] = stActivity.location[i];
                j++;
            }
            var stGPX = L.polyline(stLatLngs, {color: 'red'}).addTo(mapST)
            mapST.fitBounds(stGPX.getBounds());
          }

          $( "#STrevertButton" ).button( "option", "disabled", false ); // enable button (only needed once)
          $( "#STsendButton" ).button( "option", "disabled", false ); // enable button (only needed once)
          document.getElementById("STloc").title = ""; //remove tooltip
          calcGPSused = false;
          document.getElementById("recalcButton").value = 'Recalc';
          document.getElementById("fieldSTdata").disabled = false;
          processData(stActivity);
          $( "#timeRange" ).slider( "option", "min", 0);
          $( "#timeRange" ).slider( "option", "max", calcData.length - 1);
          $( "#timeRange" ).slider( "option", "values", [ 0, calcData.length - 1 ] );
          $( "#minTime" ).val( timeHMS( $( "#timeRange" ).slider( "values", 0)) );
          $( "#maxTime" ).val( timeHMS( $( "#timeRange" ).slider( "values", 1)) );
          calcMetrics();
          displayMetrics();
          //document.getElementById("tabs").disabled = false;
          // default data
          formSTdataOriginal = $("#fieldSTdata").serialize();
          //document.getElementById("infoText").innerHTML = "&nbsp;";
          $( "#progressSTact" ).hide();
      }

      var calcGPSused = false;
      function calcGPS(gps) {  // review which times to use
          var orig_dist_mi = (sumData[0][0][1]/MI2M).toFixed(2);
          //var durS = timeS($( "#STactiveT" ).val());
          // if (durS == -1) durS = stActivityUpdate.duration ;
          //var orig_pace = durS / orig_dist_mi;                               // seconds per mile
          //var orig_paceStr = new Date(orig_pace * 1000 + 500).toISOString().substr(14, 5);  // extra 500 ms for correct rounding
          if (calcGPSused == false) {
            var dist = 0;
            for (i = 3; i < gps.length; i=i+2) {
                dist += mapST.distance(gps[i-2], gps[i]);
            }
            var dist_mi = (dist/MI2M).toFixed(2);                                          // so same as stored value for pace calcs
            //var pace = durS / dist_mi;                                         // seconds per mile
            //var paceStr = new Date(pace * 1000 + 500).toISOString().substr(14, 5);            // extra 500 ms for correct rounding
            //var clockRatio = stActivityUpdate.clock_duration / durS
            //var elapsedStr = timeHMS(stActivityUpdate.clock_duration);
            //var elPaceStr = new Date(pace * 1000 * clockRatio + 500).toISOString().substr(14, 5);
            //var elOrigPaceStr = new Date(orig_pace * 1000 * clockRatio + 500).toISOString().substr(14, 5);
            //var noteStr = "\nSTlink distance: " + dist_mi + " mi @ " + paceStr + " /mi ";
            //noteStr += "(original " + orig_dist_mi + " mi @ " + orig_paceStr + " /mi)\n";
            //noteStr += "  Elapsed time: " + elapsedStr + " @ " + elPaceStr + " /mi (original @ " + elOrigPaceStr + " /mi)\n";
            document.getElementById("STdistance").value = dist_mi;
            document.getElementById("STactiveP").value = calcUIPace();

            displaySummary();

            document.getElementById("recalcButton").value = 'Revert';
            calcGPSused = true;
          } else {
            document.getElementById("STdistance").value = orig_dist_mi;
            document.getElementById("STactiveP").value = calcUIPace();
            document.getElementById("recalcButton").value = 'Recalc';
            calcGPSused = false;
          }
          document.getElementById("STactiveP").value = calcUIPace();

      }

      function displaySummary(){
        //var noteStr = "\nSTlink distance: " ;//+ dist_mi + " mi @ " + paceStr + " /mi " + lf;
        //  unicode space    http://jkorpela.fi/chars/spaces.html
        var noteStr = lf + "/*STlink --" + csv + "\xa0\xa0\xa0time\xa0\xa0\xa0" + csv + "\xa0\xa0\xa0dist (mi)\xa0" + csv + "\xa0pace /mi" + lf;
        noteStr += "\u2002\u2002recalc:\xa0\xa0" + csv + $( "#STactiveT" ).val() + csv +
            $( "#STdistance" ).val().padStart(7,"\u2002") + csv + "\u2002\u2002\u2002" + $( "#STactiveP" ).val() + lf;
        noteStr += "\u2005moving:\xa0\xa0" + csv + timeHMS(sumData[5][0][0]) + csv +
            distMiles(sumData[5][0][1]).toString().padStart(7,"\u2002") + csv + "\u2002\u2002\u2002" + paceMinMile(sumData[5][0][6]) + lf;
        noteStr += "\u2002\u2002watch:\xa0\xa0 " + csv + timeHMS(sumData[6][0][0]) + csv +
            distMiles(sumData[6][0][1]).toString().padStart(7,"\u2002") + csv + "\u2002\u2002\u2002" +paceMinMile(sumData[6][0][6]) + lf;
        noteStr += "\u2006elapsed:\xa0\xa0" + csv + timeHMS(sumData[0][0][0]) + csv +
            distMiles(sumData[0][0][1]).toString().padStart(7,"\u2002") + csv + "\u2002\u2002\u2002" + paceMinMile(sumData[0][0][6]) + lf;
        noteStr += "*/" + lf;

        //  look for comment and replace using '/* text */'  test.match(/\/\*ST(.*?)\*\/\n/s)  look if \n before and after   (\n)?\/\*ST(.*?)\*\/(\n)?
        var regMatch =  document.getElementById("STnotes").value.match(/(\n)?\/\*ST(.*?)\*\/(\n)?/s);
        if (regMatch != null) {
          var txtStr = document.getElementById("STnotes").value;
          var newStr = txtStr.substr(0, regMatch.index) + noteStr;
          newStr += txtStr.substr(regMatch.index + regMatch[0].length)
          //console.log(newStr);
          document.getElementById("STnotes").value = newStr;
        } else {
          document.getElementById("STnotes").value += noteStr;
        }
      }

      function getLocation(gps) {
          // add attribution to page
          //console.log(gps, typeof gps);
          if (typeof gps !== 'undefined') {
            var latCoord = gps[1][0];
            var lonCoord = gps[1][1];
            // max rate 2 per second (see if get any errors)
            var urlLiq = 'https://us1.locationiq.com/v1/reverse.php?key=' + config.locIQkey + '&format=json&' +
                'normalizeaddress=1&normalizecity=1&statecode=1&' +
                'lat=' + latCoord + '&lon=' + lonCoord;
            // max rate is 1 per second (need to add protection)
            // var urlOSM ='https://nominatim.openstreetmap.org/reverse?format=jsonv2&' +
            //     'lat=' + latCoord + '&lon=' + lonCoord;
            //var policy = {'User-Agent': 'FPE SportTracks Editor'};  // per policy
            //console.log(urlOSM);
            //console.log(urlLiq);
            $.ajax({
                type: 'GET',
                url: urlLiq
                // url: urlOSM,
                // headers: {
                //   'User-Agent': 'FPE SportTracks Editor'
                // }
            })
            .done(function(data, status){
                //console.log('data = ', data);
                // US: [name,] city, state_code     (if country_code == 'us')
                // non-US: [name,] city, country_code
                var locData = JSON.stringify(data.address, null, 5);
                var locAddress = typeof data.address.name === 'undefined' ? "" : data.address.name + ', ';
                if (data.address.country_code == 'us') {
                  locAddress += data.address.city + ", " + data.address.state_code.toUpperCase();
                } else {   // non-US
                  locAddress += data.address.city + ", " + data.address.country_code.toUpperCase();
                }
                document.getElementById("STloc").value = locAddress;
                document.getElementById("STloc").title = locData;
            })
            .fail(function(response) {
              window.alert("Geocode request failed.");
            });
          }
      }

      function calcUIPace() {
        var uiDistMI = parseFloat($( "#STdistance" ).val());  // should be a valid number due to UI checks
        var uiTimeS = timeS($( "#STactiveT" ).val());         // should be a valid number due to UI checks, if not =-1
        var paceStr = "";

        if ( !(isNaN(uiDistMI)) && uiDistMI != 0  && uiTimeS != -1) {
          var pace = uiTimeS / uiDistMI;     // seconds per mile
          paceStr = new Date(pace * 1000 + 500).toISOString().substr(14, 5);  //extra 500 ms for correct rounding
        }
        return paceStr;
      }

    </script>
</body>
</html>
