<!DOCTYPE html>
<html lang="en">
  <head>
    <title>SportTracks Editor</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
      integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
      integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
      crossorigin=""></script>

    <script
			  src="https://code.jquery.com/jquery-3.5.1.min.js"
			  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
			  crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
        integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
        crossorigin="anonymous"></script>

    <script src="./src/config.js"></script>
    <script src="./src/config_local.js"></script>
    <script src='./src/sporttracks.js'></script>

    <style>
        form  { display: table;      }
        p     { display: table-row;  }
        label { display: table-cell; vertical-align: top}
        input { display: table-cell; }

        body  { font-size: 100%; font-family: Arial,Helvetica,sans-serif; }
        input, button, select, option, textarea { font-size: 100%; }
        .ui-widget { font-size:80%; }
        .ui-tooltip { white-space: pre-line; }

        fieldset { display:inline }
        pre { font-size: 100%; font-family: Arial,Helvetica,sans-serif; }
        textarea { font-family: inherit; font-size: inherit; }

  	</style>

</head>
<body>
<h2>SportTracks - Edit workout data</h2>

<div id="invisibleMap"></div>
<pre id="infoText">SportTrack authorization dialog should appear. If not check Browser Pop-up settings.</pre>

<div>
  <fieldset  id="fieldSTindex">
    <legend>Activity Index</legend>
    <input id="STindex" name="STindex" value="1" size="10" style="padding-right:5px; text-align:right;"
    title="1 = latest activity, 2 = 2nd, etc&#013; or enter STmobi index number">&nbsp;
    <input type="submit" id="STgetButton" onclick="getSTdata()" value="Get from ST">
  </fieldset>
</div>
<br>

<div style="display: inline-block">
  <fieldset id="fieldSTdata">
    <legend>Activity Overview</legend>
    <p>
  		<label id="labelSTtypedate">Type: </label>
  		<input type="text" id="STtypedate" name="STtypedate" size="45" readonly>
  	</p>
  	<p>
  		<label id="labelSTactivity">Activity: </label>
  		<input type="url" id="STactivity" name="STactivity" size="45" readonly>
  	</p>
    <p>
      <label for="STname" id="labelSTname">Name: </label>
      <input type="text" id="STname" name="STname" size="45">
  	</p>
    <p>
      <label for="STloc" id="labelSTloc">Location: </label>
      <input type="text" id="STloc" name="STloc" size="45">&nbsp;
      <input type="button" id="getLocButton" onclick="getLocation(stActivityUpdate.location)" value="Get Location"
          title="Location uses: [name,] city, state/country &#013; (Search by LocationIQ.com)">
    </p>
  	<p>
      <label for="STdistance">Distance:&nbsp;</label>
      <input type="text" id="STdistance" name="STname" size="7" style="padding-right:30px; text-align:right;"></input><span style="margin-left:-25px;">mi</span>&nbsp;&nbsp;&nbsp;
  	  <input type="button" id="recalcButton" onclick="calcGPS(stActivityUpdate.location)" value="Recalc"
          title="Recalculate distance based on simple addition of GPS points">
  	</p>
    <label for="STnotes">Notes:</label>
    <textarea rows = "5" cols = "60" id="STnotes" name="STnotes">
    </textarea><br>
  	<br>
    <input type="submit" id="STsendButton" onclick="setSTdata()" value="Send to ST">&nbsp;&nbsp;
  	<input type="button" id="STrevertButton" onclick="revertSTdata()" value="Revert">

  	<br><br>
  </fieldset>
</div>
<div style="display: inline-block; vertical-align: top">
  <fieldset>
    <legend>Gear</legend>
    <div class="arrowButtons">
        <input type="button" id="STgetGearButton" onclick="getSTgearList()" value="Get Gear">&nbsp;&nbsp;
        <button id="gearLeft">Change Gear page</button>
        <button id="gearRight">Change Gear page</button>
        <br><br>
    </div>
    <div id="fieldSTgear">
    </div>
  </fieldset>
</div>
<br>
<br>

    <script>
      // setup SportTracksLink (if appropriate)
      //stTokens(); // setup tokens at startup - may need to refresh later
    	// where possible keep all references to HTML fields on this page
      var map = L.map('invisibleMap');

      document.getElementById("fieldSTindex").disabled = true;
      document.getElementById("fieldSTdata").disabled = true;
      sportTracksInfo(3);  // initialize

      function enableForm() { // ST connection made, enable index area
          document.getElementById("fieldSTindex").disabled = false;
          document.getElementById("infoText").innerHTML = "    ";
          $( "#STgetButton" ).button( "option", "disabled", false );
          $( "#STindex" ).spinner( "option", "disabled", false );
          $( "#STgetGearButton" ).button( "option", "disabled", false );
      }

      var indexSpin = false;
      var showGear = false;
      $(function() {
        // disable controls to start with
        $( "#STgetButton, #getLocButton, #recalcButton, #STrevertButton, #STsendButton, #STgetGearButton" ).button( { disabled: true } );
        $( document ).tooltip();
        $( "#fieldSTgear" ).controlgroup();
        $( "#STindex" ).spinner({
            disabled: true,
            spin: function( event, ui ) {
                indexSpin = true;
            },
            stop: function( event, ui ) {
                // do check to ignore keypresses when typing the number
                //console.log('stop ', event);
                if (indexSpin == true) {
                    indexSpin = false;
                    getSTdata();
                }
            }
        });
        $( "#STindex" ).on( "keyup", function( event ) {
            //console.log('keyup ', event, event.keyCode);
            if ( event.keyCode == $.ui.keyCode.ENTER ) {
                getSTdata();  // allow enter key to also trigger the update
            }
        });
        $( "#gearLeft"  ).button( { icon: "ui-icon-circle-arrow-w", showLabel: false } )
            .on( "click", function( event ) {
                  gearIndexPage--;
                  showSTgear();
            });
        $( "#gearRight" ).button( { icon: "ui-icon-circle-arrow-e", showLabel: false } )
            .on( "click", function( event ) {
                  gearIndexPage++;
                  showSTgear();
            });
        $(document).ajaxStop(function () {
              if (showGear == true) {  // only react to one type of finish
                showSTgear();
                showGear = false;
                document.getElementById("infoText").innerHTML = " ";
              }
        });
      })

      function getSTdata() {
      	if ($("#fieldSTdata").serialize() != formSTdataOriginal) {
         	// warn it has changed
      		if (confirm("Data changed - override from SportTracks?") == false) {
      			return false;
      		}
      	}
        //document.getElementById("fieldSTdata").disabled = true;
        //document.getElementById("locText").innerHTML = "";
        document.getElementById("infoText").innerHTML = "Getting data...";
        getFitnessActivityIndex( document.getElementById("STindex").value);
        return false;  // needed to avoid page refresh
      }

      function setSTdata() {
      	if (confirm("Send data to SportTracks?") == true) {
          stActivityUpdate.name = document.getElementById("STname").value;
          stActivityUpdate.location_name = document.getElementById("STloc").value;
          stActivityUpdate.total_distance = document.getElementById("STdistance").value * 1609.34;
          stActivityUpdate.notes = document.getElementById("STnotes").value;
          setFitnessActivity(stActivityUpdate);
          //make new text the baseline
          formSTdataOriginal = $("#fieldSTdata").serialize();
      	}
        return false;  // needed to avoid page refresh
      }

      function revertSTdata() {
        populateSTform (stActivityInit);
      }

      var gearIndexPage = 0;
      function showSTgear() {
        // show gear list (global variable)
        // clear existing list
        $('#fieldSTgear').find('input').each(function () {
            $(this).remove();
            $('label[for=' + $(this).attr('id') + ']').remove();
        });
        var numGear = 8;
        var totalGear = stGearList.length;
        var maxPage = Math.ceil(totalGear / numGear) - 1;
        if (gearIndexPage > maxPage) gearIndexPage = 0;
        if (gearIndexPage < 0) gearIndexPage = maxPage;
        var maxOnPage = gearIndexPage < maxPage ? numGear : totalGear - maxPage*numGear
        var minI = numGear*gearIndexPage;
        var maxI = minI + maxOnPage;
        // test for max
        for (i = minI; i < maxI; i++) {
            var newCBox = '<input type="checkbox" name="checkbox-' + i + '" id="checkbox-' + i + '" /> <label for="checkbox-'+ i + '">test</label';
            $( "#fieldSTgear" ).append(newCBox);
            $( "#fieldSTgear" ).controlgroup( "option", "direction", "vertical" );
            var gearLbl = stGearList[i].brand + ' - ' + stGearList[i].model;
            $( "#checkbox-" + i ).checkboxradio( { label: gearLbl } ).checkboxradio( "refresh" );
        }
      }



      // populate form
      function populateSTform (stActivity) {
          var stDate = new Date (stActivity.start_time);
          if (stTest == true) {
            window.alert("SportTracks - index " + stIndex + ": \n  " + stActivity.name + " (" + stActivity.toLocaleString() + ")\n  " + stActivity.uri);
          }
          document.getElementById("STtypedate").value = stActivity.type + " (" + stDate.toLocaleString() + ")";
          document.getElementById("STactivity").value = stActivity.activity;
          document.getElementById("STname").value = stActivity.name;
          document.getElementById("STloc").value = typeof stActivity.location_name === 'undefined' ? "" : stActivity.location_name;
          document.getElementById("STdistance").value = (stActivity.total_distance/1609.34).toFixed(2);  // convert to miles, show 2 dp
          document.getElementById("STnotes").value = typeof stActivity.notes === 'undefined' ? "" : stActivity.notes;
          $( "#getLocButton" ).button( "option", "disabled", typeof stActivity.location === 'undefined' ); // button enabled if GPS data
          $( "#recalcButton" ).button( "option", "disabled", typeof stActivity.location === 'undefined' ); // button enabled if GPS data
          $( "#STrevertButton" ).button( "option", "disabled", false ); // enable button (only needed once)
          $( "#STsendButton" ).button( "option", "disabled", false ); // enable button (only needed once)
          //$( "#STgetGearButton" ).button( "option", "disabled", false ); // enable button (only needed once)
          document.getElementById("fieldSTdata").disabled = false;
          // default data
          formSTdataOriginal = $("#fieldSTdata").serialize();
          document.getElementById("infoText").innerHTML = "    ";
      }

      function calcGPS(gps) {
          var dist = 0;
          for (i = 3; i < gps.length; i=i+2) {
              dist += map.distance(gps[i-2], gps[i]);
          }
          var dist_mi = dist/1609.34;
          var orig_dist_mi = stActivityInit.total_distance/1609.34;
          document.getElementById("STdistance").value = (dist_mi).toFixed(2);
          document.getElementById("STnotes").value += "\nSTlink distance: " + dist_mi.toFixed(2) + " mi (original: " + orig_dist_mi.toFixed(2) +
            " mi)\n";
      }

      function getLocation(gps) {
          // add attribution to page
          //console.log(gps, typeof gps);
          if (typeof gps !== 'undefined') {
            var latCoord = gps[1][0];
            var lonCoord = gps[1][1];
            // max rate 2 per second (see if get any errors)
            var urlLiq = 'https://us1.locationiq.com/v1/reverse.php?key=' + config.locIQkey + '&format=json&' +
                'normalizeaddress=1&normalizecity=1&statecode=1&' +
                'lat=' + latCoord + '&lon=' + lonCoord;
            // max rate is 1 per second (need to add protection)
            // var urlOSM ='https://nominatim.openstreetmap.org/reverse?format=jsonv2&' +
            //     'lat=' + latCoord + '&lon=' + lonCoord;
            //var policy = {'User-Agent': 'FPE SportTracks Editor'};  // per policy
            //console.log(urlOSM);
            //console.log(urlLiq);
            $.ajax({
                type: 'GET',
                url: urlLiq
                // url: urlOSM,
                // headers: {
                //   'User-Agent': 'FPE SportTracks Editor'
                // }
            })
            .done(function(data, status){
                //console.log('data = ', data);
                // US: [name,] city, state_code     (if country_code == 'us')
                // non-US: [name,] city, country_code
                var locData = JSON.stringify(data.address, null, 5);
                var locAddress = typeof data.address.name === 'undefined' ? "" : data.address.name + ', ';
                if (data.address.country_code == 'us') {
                  locAddress += data.address.city + ", " + data.address.state_code.toUpperCase();
                } else {   // non-US
                  locAddress += data.address.city + ", " + data.address.country_code.toUpperCase();
                }
                document.getElementById("STloc").value = locAddress;
                document.getElementById("STloc").title = locData;
            })
            .fail(function(response) {
              window.alert("Geocode request failed.");
            });
          }
      }

    </script>
</body>
</html>
